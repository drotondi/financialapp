<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finanzas personales - Activos y Pasivos</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --accent: #10b981;
      --accent-2: #60a5fa;
      --accent-3: #f59e0b;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      background: radial-gradient(circle at 10% 20%, rgba(96,165,250,0.12), transparent 25%),
                  radial-gradient(circle at 90% 10%, rgba(16,185,129,0.12), transparent 20%),
                  linear-gradient(180deg, #0b1220 0%, #0f172a 60%);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      padding: 24px 20px 8px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.5px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--accent);
      background: rgba(16, 185, 129, 0.12);
      border: 1px solid rgba(16,185,129,0.2);
    }

    .grid {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 20px 32px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 16px 18px 18px;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .muted { color: var(--muted); }

    label { display: block; margin-bottom: 6px; font-size: 14px; }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent-2);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.2);
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      font-weight: 600;
      color: #0b1220;
      background: linear-gradient(90deg, #34d399, #10b981);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 20px rgba(16,185,129,0.25);
      width: 100%;
    }

    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    .secondary-btn {
      background: #111827;
      color: var(--text);
      border: 1px solid #1f2937;
      box-shadow: none;
    }

    .flex-row { display: flex; gap: 10px; }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 14px;
    }

    .table th, .table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #1f2937;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(96,165,250,0.14);
      color: #dbeafe;
      border-radius: 999px;
      font-size: 12px;
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .badge {
      display: inline-block;
      background: rgba(16,185,129,0.14);
      color: #c3f8e6;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      border: 1px solid rgba(16,185,129,0.25);
    }

    .type-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      color: #0b1220;
    }

    .type-activo { background: rgba(16,185,129,0.18); color: #c3f8e6; border: 1px solid rgba(16,185,129,0.25); }
    .type-pasivo { background: rgba(239,68,68,0.16); color: #fecdd3; border: 1px solid rgba(248,113,113,0.25); }

    .breakdown-list { display: grid; gap: 8px; margin: 10px 0 0; padding: 0; list-style: none; }
    .breakdown-item { background: #0f172a; border: 1px solid #1f2937; border-radius: 10px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }

    @media (max-width: 720px) {
      header { padding: 18px 16px 0; }
      .grid { padding: 8px 16px 24px; }
      .flex-row { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="title">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--accent);"></div>
      <h1>Panel de finanzas personales</h1>
      <span class="pill">HTML + local/Supabase</span>
    </div>
      <p class="muted" style="margin: 6px 0 14px; max-width: 820px;">
      Registra activos y pasivos en un solo panel. Puedes iniciar sesión (demo o Supabase), elegir almacenamiento local o Supabase (gratuito), exportar/importar CSV y generar un PDF.
    </p>
    <div class="totals">
      <div class="card">
        <div class="muted" style="font-size: 13px;">Total activos</div>
        <div style="font-size: 26px; font-weight: 700;" id="total-activos">$0.00</div>
        <div class="badge" id="count-activos">0 registros</div>
      </div>
      <div class="card">
        <div class="muted" style="font-size: 13px;">Total pasivos</div>
        <div style="font-size: 26px; font-weight: 700;" id="total-pasivos">$0.00</div>
        <div class="badge" id="count-pasivos">0 registros</div>
      </div>
      <div class="card">
        <div class="muted" style="font-size: 13px;">Sesión y almacenamiento</div>
        <div style="display: grid; gap: 8px;">
          <div id="session-box" class="badge" style="background: rgba(96,165,250,0.12); color: #bfdbfe; border-color: rgba(96,165,250,0.3);">Sin sesión</div>
          <div class="flex-row">
            <button class="secondary-btn" id="open-login" type="button">Iniciar sesión</button>
            <button class="secondary-btn" id="logout" type="button">Cerrar sesión</button>
          </div>
          <div>
            <label for="storage-mode">Almacenamiento</label>
            <select id="storage-mode">
              <option value="local">Local (navegador)</option>
              <option value="supabase">Supabase (gratuito)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="muted" style="font-size: 13px;">Acciones rápidas</div>
        <div class="flex-row">
          <button class="secondary-btn" id="pdf-report" type="button">Generar PDF</button>
          <button class="secondary-btn" id="export-data" type="button">Exportar CSV</button>
          <button class="secondary-btn" id="import-data" type="button">Importar CSV</button>
          <input type="file" id="import-file" accept=".csv" style="display: none;">
          <button class="secondary-btn" id="clear-data" type="button" style="color: #fca5a5; border-color: #b91c1c;">Borrar datos</button>
        </div>
      </div>
    </div>
  </header>

  <main class="grid">
    <section class="card" id="auth-card" style="grid-column: 1 / -1; display: none;">
      <h2>Acceso</h2>
      <p class="muted" style="margin-top: 0;">Usa el usuario demo <strong>demo@demo.test</strong> / <strong>demo123</strong> o tus credenciales de Supabase (si configuras URL y clave) para acceder.</p>
      <form id="login-form" class="flex-row">
        <div style="flex: 1;">
          <label for="email">Correo</label>
          <input id="email" name="email" type="email" placeholder="demo@demo.test" required>
        </div>
        <div style="flex: 1;">
          <label for="password">Contraseña</label>
          <input id="password" name="password" type="password" placeholder="demo123" required>
        </div>
        <div style="flex: 1; align-self: end;">
          <button type="submit">Entrar</button>
        </div>
      </form>
      <div style="display: grid; gap: 8px; margin-top: 12px;">
        <label for="supabase-url">Supabase URL (opcional)</label>
        <input id="supabase-url" name="supabase-url" placeholder="https://xyzcompany.supabase.co">
        <label for="supabase-key">Supabase anon key (opcional)</label>
        <input id="supabase-key" name="supabase-key" placeholder="eyJ...">
        <button class="secondary-btn" id="save-supabase" type="button">Guardar configuración Supabase</button>
        <div class="muted" style="font-size: 13px;">Si eliges Supabase como almacenamiento, se usarán estos datos. Crea gratis un proyecto en supabase.com, habilita autenticación por correo/contraseña y una tabla pública llamada <code>registros_financieros</code> con columnas <code>id: uuid</code> (PK), <code>type</code>, <code>name</code>, <code>category</code>, <code>amount</code> numeric, <code>currency</code>, <code>date</code>, <code>notes</code>, <code>owner</code> (text) y <code>created_at</code> timestamp default now().</div>
      </div>
    </section>
    <section class="card">
        <h2>Registrar transacción</h2>
        <form id="record-form">
          <label for="type">Tipo</label>
          <select id="type" name="type" required>
            <option value="Activo">Activo</option>
            <option value="Pasivo">Pasivo</option>
          </select>

          <label for="name">Nombre</label>
          <input id="name" name="name" placeholder="Cuenta, préstamo, vehículo" required>

          <label for="category">Categoría / Clase</label>
          <select id="category" name="category" required></select>
          <div id="custom-category-wrapper" style="margin-top: 8px; display: none;">
            <input id="custom-category" name="custom-category" placeholder="Escribe la categoría" />
          </div>

        <label for="amount">Monto</label>
        <input id="amount" name="amount" type="number" step="0.01" min="0" placeholder="5000" required>

        <label for="currency">Divisa</label>
        <input id="currency" name="currency" placeholder="USD, EUR, MXN" value="USD">

        <label for="date">Fecha</label>
        <input id="date" name="date" type="date" required>

        <label for="notes">Notas</label>
        <textarea id="notes" name="notes" rows="2" placeholder="Detalles, plazo, broker, etc."></textarea>

        <button type="submit" style="margin-top: 10px;">Agregar registro</button>
      </form>
    </section>

    <section class="card">
      <h2>Dashboard</h2>
      <canvas id="totals-chart" height="220"></canvas>
      <p class="muted" style="margin: 8px 0 0; font-size: 13px;">Distribución total por tipo (activos vs pasivos).</p>
    </section>

    <section class="card">
      <h2>Detalle de activos</h2>
      <ul class="breakdown-list" id="breakdown-activos"></ul>
    </section>
    <section class="card">
      <h2>Detalle de pasivos</h2>
      <ul class="breakdown-list" id="breakdown-pasivos"></ul>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
        <h2 style="margin: 0;">Listado de registros</h2>
        <div class="muted" style="font-size: 13px;">Los montos se muestran en la divisa que ingreses; no se aplican cambios de moneda.</div>
      </div>
      <div style="overflow-x: auto; margin-top: 10px;">
        <table class="table" id="records-table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Nombre</th>
              <th>Categoría / Clase</th>
              <th>Valor</th>
              <th>Divisa</th>
              <th>Fecha</th>
              <th>Notas</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const recordForm = document.getElementById('record-form');
    const typeSelect = document.getElementById('type');
    const tableBody = document.querySelector('#records-table tbody');
    const totalActivosEl = document.getElementById('total-activos');
    const totalPasivosEl = document.getElementById('total-pasivos');
    const countActivosEl = document.getElementById('count-activos');
    const countPasivosEl = document.getElementById('count-pasivos');
    const exportBtn = document.getElementById('export-data');
    const importBtn = document.getElementById('import-data');
    const importFileInput = document.getElementById('import-file');
    const clearBtn = document.getElementById('clear-data');
    const pdfBtn = document.getElementById('pdf-report');
    const breakdownActivos = document.getElementById('breakdown-activos');
    const breakdownPasivos = document.getElementById('breakdown-pasivos');
    const categorySelect = document.getElementById('category');
    const customCategoryInput = document.getElementById('custom-category');
    const customCategoryWrapper = document.getElementById('custom-category-wrapper');
    const dateInput = document.getElementById('date');
    const chartCanvas = document.getElementById('totals-chart');
    const storageModeSelect = document.getElementById('storage-mode');
    const sessionBox = document.getElementById('session-box');
    const openLoginBtn = document.getElementById('open-login');
    const logoutBtn = document.getElementById('logout');
    const authCard = document.getElementById('auth-card');
    const loginForm = document.getElementById('login-form');
    const supabaseUrlInput = document.getElementById('supabase-url');
    const supabaseKeyInput = document.getElementById('supabase-key');
    const saveSupabaseBtn = document.getElementById('save-supabase');
    let totalsChart;
    let supabaseClient = null;
    let currentUser = null;
    let currentStorage = localStorage.getItem('storage-mode') || 'local';

    const CATEGORY_OPTIONS = {
      Activo: [
        'Efectivo',
        'Cuenta bancaria',
        'Propiedad',
        'Vehículo',
        'Ahorro / Fondo',
        'Otros activos',
        'Otro (escribe)'
      ],
      Pasivo: [
        'Tarjeta de crédito',
        'Préstamo personal',
        'Hipoteca',
        'Servicios / Facturas',
        'Impuestos',
        'Otros pasivos',
        'Otro (escribe)'
      ]
    };

    const LOCAL_KEY = 'records';
    const DEMO_USER = { email: 'demo@demo.test', password: 'demo123', name: 'Demo' };
    const SUPABASE_TABLE = 'registros_financieros';

    const currencyFormat = (value) => new Intl.NumberFormat('es-ES', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    }).format(value || 0);
    const generateId = () => (crypto.randomUUID ? crypto.randomUUID() : `id-${Date.now()}-${Math.random()}`);

    const setSession = (user) => {
      currentUser = user;
      if (user) {
        sessionStorage.setItem('session-user', JSON.stringify(user));
        sessionBox.textContent = `Sesión: ${user.email}`;
        sessionBox.style.background = 'rgba(16,185,129,0.18)';
        sessionBox.style.color = '#c3f8e6';
        sessionBox.style.borderColor = 'rgba(16,185,129,0.3)';
      } else {
        sessionStorage.removeItem('session-user');
        sessionBox.textContent = 'Sin sesión';
        sessionBox.style.background = 'rgba(96,165,250,0.12)';
        sessionBox.style.color = '#bfdbfe';
        sessionBox.style.borderColor = 'rgba(96,165,250,0.3)';
      }
    };

    const getSupabaseConfig = () => ({
      url: localStorage.getItem('supabase-url') || '',
      key: localStorage.getItem('supabase-key') || '',
    });

    const ensureSupabase = () => {
      const { url, key } = getSupabaseConfig();
      if (!url || !key) return null;
      if (supabaseClient) return supabaseClient;
      supabaseClient = window.supabase.createClient(url, key);
      return supabaseClient;
    };

    const storageAdapters = {
      local: {
        load: async () => JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]'),
        add: async (record) => {
          const records = await storageAdapters.local.load();
          records.unshift(record);
          localStorage.setItem(LOCAL_KEY, JSON.stringify(records));
          return record;
        },
        remove: async (id) => {
          const records = await storageAdapters.local.load();
          const filtered = records.filter((r) => r.id !== id);
          localStorage.setItem(LOCAL_KEY, JSON.stringify(filtered));
          return true;
        },
        replaceAll: async (records) => {
          localStorage.setItem(LOCAL_KEY, JSON.stringify(records));
          return records.length;
        },
        clear: async () => { localStorage.removeItem(LOCAL_KEY); },
      },
      supabase: {
        load: async () => {
          const client = ensureSupabase();
          if (!client || !currentUser) return [];
          const { data, error } = await client
            .from(SUPABASE_TABLE)
            .select('*')
            .eq('owner', currentUser.email)
            .order('created_at', { ascending: false });
          if (error) {
            console.warn('Supabase load error', error.message);
            alert('No se pudieron leer datos de Supabase: ' + error.message);
            return [];
          }
          return data || [];
        },
        add: async (record) => {
          const client = ensureSupabase();
          if (!client || !currentUser) throw new Error('Configura Supabase e inicia sesión');
          const payload = { ...record, owner: currentUser.email };
          const { error, data } = await client.from(SUPABASE_TABLE).insert(payload).select().single();
          if (error) throw new Error(error.message);
          return data;
        },
        remove: async (id) => {
          const client = ensureSupabase();
          if (!client || !currentUser) throw new Error('Configura Supabase e inicia sesión');
          const { error } = await client.from(SUPABASE_TABLE).delete().eq('id', id).eq('owner', currentUser.email);
          if (error) throw new Error(error.message);
          return true;
        },
        replaceAll: async (records) => {
          const client = ensureSupabase();
          if (!client || !currentUser) throw new Error('Configura Supabase e inicia sesión');
          await client.from(SUPABASE_TABLE).delete().eq('owner', currentUser.email);
          if (!records.length) return 0;
          const payload = records.map((r) => ({ ...r, owner: currentUser.email }));
          const { error, count } = await client.from(SUPABASE_TABLE).insert(payload, { count: 'exact' });
          if (error) throw new Error(error.message);
          return count || payload.length;
        },
        clear: async () => {
          const client = ensureSupabase();
          if (!client || !currentUser) throw new Error('Configura Supabase e inicia sesión');
          await client.from(SUPABASE_TABLE).delete().eq('owner', currentUser.email);
        },
      },
    };

    const toCSV = (records) => {
      const headers = ['id', 'type', 'name', 'category', 'amount', 'currency', 'date', 'notes', 'owner'];
      const escape = (value) => `"${String(value ?? '').replace(/"/g, '""')}"`;
      const lines = records.map((item) => headers.map((h) => escape(item[h])).join(','));
      return [headers.join(','), ...lines].join('\n');
    };

    const splitCSVLine = (line) => {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result.map((v) => v.trim());
    };

    const parseCSV = (text) => {
      const lines = text.split(/\r?\n/).filter((l) => l.trim().length);
      if (!lines.length) return [];
      const headers = splitCSVLine(lines[0]).map((h) => h.toLowerCase());
      const indices = {
        id: headers.indexOf('id'),
        type: headers.indexOf('type'),
        name: headers.indexOf('name'),
        category: headers.indexOf('category'),
        amount: headers.indexOf('amount'),
        currency: headers.indexOf('currency'),
        date: headers.indexOf('date'),
        notes: headers.indexOf('notes'),
        owner: headers.indexOf('owner'),
      };

      return lines.slice(1).map((line) => {
        const cols = splitCSVLine(line);
        const record = {
          id: cols[indices.id]?.trim() || generateId(),
          type: cols[indices.type]?.trim(),
          name: cols[indices.name]?.trim(),
          category: cols[indices.category]?.trim(),
          amount: Number(cols[indices.amount] || 0),
          currency: cols[indices.currency]?.trim() || 'USD',
          date: cols[indices.date]?.trim() || '',
          notes: cols[indices.notes]?.trim() || '',
          owner: cols[indices.owner]?.trim() || '',
        };
        return record;
      }).filter((r) => r.type && ['Activo', 'Pasivo'].includes(r.type) && r.name && r.category);
    };

    const getAdapter = () => storageAdapters[currentStorage] || storageAdapters.local;
    const loadRecords = async () => getAdapter().load();
    const addRecord = async (record) => getAdapter().add(record);
    const removeRecord = async (id) => getAdapter().remove(id);
    const replaceAllRecords = async (records) => getAdapter().replaceAll(records);
    const clearRecords = async () => getAdapter().clear();

    const groupByCategory = (records, type) => {
      const filtered = records.filter((r) => r.type === type);
      return filtered.reduce((acc, item) => {
        const key = item.category || 'Sin categoría';
        acc[key] = (acc[key] || 0) + Number(item.amount || 0);
        return acc;
      }, {});
    };

    const renderBreakdown = (container, grouped) => {
      container.innerHTML = '';
      const entries = Object.entries(grouped).sort((a, b) => b[1] - a[1]);
      if (!entries.length) {
        container.innerHTML = '<li class="muted">Sin registros</li>';
        return;
      }
      entries.forEach(([category, total]) => {
        const li = document.createElement('li');
        li.className = 'breakdown-item';
        li.innerHTML = `<span>${category}</span><strong>$${currencyFormat(total)}</strong>`;
        container.appendChild(li);
      });
    };

    const renderChart = (totals) => {
      const data = [totals.activos, totals.pasivos];
      const labels = ['Activos', 'Pasivos'];
      if (totalsChart) {
        totalsChart.data.datasets[0].data = data;
        totalsChart.update();
        return;
      }
      totalsChart = new Chart(chartCanvas, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: ['#10b981', '#ef4444'],
            borderColor: '#0f172a',
          }],
        },
        options: {
          plugins: {
            legend: { labels: { color: '#e5e7eb' } },
          },
        },
      });
    };

    const render = async () => {
      const raw = await loadRecords();
      let normalized = raw.map((r) => (r.id ? r : { ...r, id: generateId() }));
      const hasMissingIds = normalized.some((item, idx) => !raw[idx]?.id);
      if (hasMissingIds) {
        try { await replaceAllRecords(normalized); } catch (_) {}
      }
      const records = normalized;
      tableBody.innerHTML = '';

      records.forEach((row, index) => {
        const tr = document.createElement('tr');
        const typeClass = row.type === 'Activo' ? 'type-activo' : 'type-pasivo';
        tr.innerHTML = `
          <td><span class="type-pill ${typeClass}">${row.type}</span></td>
          <td>${row.name}</td>
          <td>${row.category}</td>
          <td>$${currencyFormat(row.amount)}</td>
          <td>${row.currency || 'USD'}</td>
          <td>${row.date || ''}</td>
          <td>${row.notes || ''}</td>
          <td><button class="secondary-btn" data-id="${row.id}" type="button" style="color: #fca5a5; border-color: #b91c1c;">Eliminar</button></td>
        `;
        tableBody.appendChild(tr);
      });

      const totals = records.reduce((acc, item) => {
        const amt = Number(item.amount || 0);
        if (item.type === 'Activo') acc.activos += amt;
        if (item.type === 'Pasivo') acc.pasivos += amt;
        return acc;
      }, { activos: 0, pasivos: 0 });

      totalActivosEl.textContent = `$${currencyFormat(totals.activos)}`;
      totalPasivosEl.textContent = `$${currencyFormat(totals.pasivos)}`;

      const counts = records.reduce((acc, item) => {
        acc[item.type] = (acc[item.type] || 0) + 1;
        return acc;
      }, {});

      countActivosEl.textContent = `${counts['Activo'] || 0} registros`;
      countPasivosEl.textContent = `${counts['Pasivo'] || 0} registros`;

      renderBreakdown(breakdownActivos, groupByCategory(records, 'Activo'));
      renderBreakdown(breakdownPasivos, groupByCategory(records, 'Pasivo'));

      renderChart(totals);
    };

    const populateCategories = (type) => {
      const options = CATEGORY_OPTIONS[type] || [];
      categorySelect.innerHTML = '';
      options.forEach((cat) => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
      toggleCustomCategory();
    };

    const toggleCustomCategory = () => {
      const needsCustom = categorySelect.value && categorySelect.value.includes('Otro');
      customCategoryWrapper.style.display = needsCustom ? 'block' : 'none';
      customCategoryInput.required = !!needsCustom;
      if (!needsCustom) customCategoryInput.value = '';
    };

    recordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(recordForm);
      const newRecord = {
        id: generateId(),
        type: formData.get('type'),
        name: formData.get('name').trim(),
        category: (formData.get('category').includes('Otro')
          ? formData.get('custom-category').trim()
          : formData.get('category')).trim(),
        amount: Number(formData.get('amount')),
        currency: formData.get('currency').trim() || 'USD',
        date: formData.get('date'),
        notes: formData.get('notes').trim(),
        owner: currentUser?.email || '',
      };

      if (!newRecord.name || !newRecord.category || Number.isNaN(newRecord.amount)) return;

      try {
        await addRecord(newRecord);
        recordForm.reset();
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        render();
      } catch (err) {
        alert('No se pudo guardar: ' + err.message);
      }
    });

    tableBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      try {
        await removeRecord(btn.dataset.id);
        render();
      } catch (err) {
        alert('No se pudo eliminar: ' + err.message);
      }
    });

    exportBtn.addEventListener('click', async () => {
      const data = await loadRecords();
      const csv = toCSV(data);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'finanzas.csv';
      link.click();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => importFileInput.click());

    importFileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        const text = evt.target?.result;
        if (typeof text !== 'string') return;
        const imported = parseCSV(text);
        if (!imported.length) {
          alert('No se encontraron filas válidas en el CSV.');
          return;
        }
        try {
          const existing = await loadRecords();
          await replaceAllRecords([...imported, ...existing]);
          render();
          importFileInput.value = '';
        } catch (err) {
          alert('No se pudo importar: ' + err.message);
        }
      };
      reader.readAsText(file);
    });

    clearBtn.addEventListener('click', async () => {
      const confirmed = confirm('¿Seguro que deseas borrar todos los registros locales?');
      if (!confirmed) return;
      try {
        await clearRecords();
        render();
      } catch (err) {
        alert('No se pudo borrar: ' + err.message);
      }
    });

    pdfBtn.addEventListener('click', async () => {
      const records = await loadRecords();
      const totals = records.reduce((acc, item) => {
        const amt = Number(item.amount || 0);
        if (item.type === 'Activo') acc.activos += amt;
        if (item.type === 'Pasivo') acc.pasivos += amt;
        return acc;
      }, { activos: 0, pasivos: 0 });

      const reportWindow = window.open('', '_blank');
      const now = new Date();
      const dateStr = now.toLocaleDateString('es-ES');
      const timeStr = now.toLocaleTimeString('es-ES');
      const rows = records.map((r, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td>${r.type}</td>
          <td>${r.name}</td>
          <td>${r.category}</td>
          <td>${r.currency || 'USD'} ${currencyFormat(r.amount)}</td>
          <td>${r.date || ''}</td>
          <td>${r.notes || ''}</td>
        </tr>`).join('');

      reportWindow.document.write(`
        <html><head><title>Reporte financiero</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1, h2 { margin-bottom: 6px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; font-size: 12px; }
          th { background: #f1f5f9; }
          .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
          .card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
        </style></head><body>
        <h1>Reporte financiero</h1>
        <div>Generado el ${dateStr} a las ${timeStr}</div>
        <div class="summary">
          <div class="card"><strong>Total activos:</strong> $${currencyFormat(totals.activos)}</div>
          <div class="card"><strong>Total pasivos:</strong> $${currencyFormat(totals.pasivos)}</div>
        </div>
        <h2>Registros</h2>
        <table>
          <thead><tr><th>#</th><th>Tipo</th><th>Nombre</th><th>Categoría</th><th>Valor</th><th>Fecha</th><th>Notas</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="7">Sin registros</td></tr>'}</tbody>
        </table>
        </body></html>`);
      reportWindow.document.close();
      reportWindow.focus();
      reportWindow.print();
    });

    const loadSavedSession = () => {
      const cached = sessionStorage.getItem('session-user');
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          setSession(parsed);
        } catch (err) {
          sessionStorage.removeItem('session-user');
        }
      }
    };

    const toggleAuthCard = (show) => {
      authCard.style.display = show ? 'block' : 'none';
    };

    openLoginBtn.addEventListener('click', () => toggleAuthCard(true));
    logoutBtn.addEventListener('click', async () => {
      if (supabaseClient) {
        await supabaseClient.auth.signOut();
      }
      setSession(null);
      toggleAuthCard(false);
      render();
    });

    saveSupabaseBtn.addEventListener('click', () => {
      localStorage.setItem('supabase-url', supabaseUrlInput.value.trim());
      localStorage.setItem('supabase-key', supabaseKeyInput.value.trim());
      alert('Configuración de Supabase guardada.');
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginForm.email.value.trim();
      const password = loginForm.password.value;
      const { url, key } = getSupabaseConfig();
      try {
        if (url && key) {
          const client = ensureSupabase();
          const { data, error } = await client.auth.signInWithPassword({ email, password });
          if (error) throw new Error(error.message);
          setSession({ email: data.user.email, provider: 'supabase' });
        } else if (email === DEMO_USER.email && password === DEMO_USER.password) {
          setSession({ email: DEMO_USER.email, provider: 'demo' });
        } else {
          throw new Error('Credenciales inválidas o falta configurar Supabase.');
        }
        toggleAuthCard(false);
        render();
      } catch (err) {
        alert('No se pudo iniciar sesión: ' + err.message);
      }
    });

    storageModeSelect.addEventListener('change', () => {
      const mode = storageModeSelect.value;
      const { url, key } = getSupabaseConfig();
      if (mode === 'supabase' && (!url || !key)) {
        alert('Configura URL y clave de Supabase antes de usar este modo.');
        storageModeSelect.value = currentStorage;
        return;
      }
      currentStorage = mode;
      localStorage.setItem('storage-mode', mode);
      render();
    });

    const init = () => {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      populateCategories('Activo');
      const savedStorage = localStorage.getItem('storage-mode');
      if (savedStorage) {
        currentStorage = savedStorage;
        storageModeSelect.value = savedStorage;
      }
      const { url, key } = getSupabaseConfig();
      supabaseUrlInput.value = url;
      supabaseKeyInput.value = key;
      loadSavedSession();
      render();
    };

    typeSelect.addEventListener('change', (e) => {
      populateCategories(e.target.value);
    });

    categorySelect.addEventListener('change', toggleCustomCategory);

    init();
  </script>
</body>
</html>
