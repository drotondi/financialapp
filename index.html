<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finanzas personales - Activos y Pasivos</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --accent: #10b981;
      --accent-2: #60a5fa;
      --accent-3: #f59e0b;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      background: radial-gradient(circle at 10% 20%, rgba(96,165,250,0.12), transparent 25%),
                  radial-gradient(circle at 90% 10%, rgba(16,185,129,0.12), transparent 20%),
                  linear-gradient(180deg, #0b1220 0%, #0f172a 60%);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      padding: 24px 20px 8px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.5px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--accent);
      background: rgba(16, 185, 129, 0.12);
      border: 1px solid rgba(16,185,129,0.2);
    }

    .grid {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 20px 32px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 16px 18px 18px;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .muted { color: var(--muted); }

    label { display: block; margin-bottom: 6px; font-size: 14px; }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent-2);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.2);
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      font-weight: 600;
      color: #0b1220;
      background: linear-gradient(90deg, #34d399, #10b981);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 20px rgba(16,185,129,0.25);
      width: 100%;
    }

    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    .secondary-btn {
      background: #111827;
      color: var(--text);
      border: 1px solid #1f2937;
      box-shadow: none;
    }

    .flex-row { display: flex; gap: 10px; }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 14px;
    }

    .table th, .table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #1f2937;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(96,165,250,0.14);
      color: #dbeafe;
      border-radius: 999px;
      font-size: 12px;
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .badge {
      display: inline-block;
      background: rgba(16,185,129,0.14);
      color: #c3f8e6;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      border: 1px solid rgba(16,185,129,0.25);
    }

    .type-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      color: #0b1220;
    }

    .type-activo { background: rgba(16,185,129,0.18); color: #c3f8e6; border: 1px solid rgba(16,185,129,0.25); }
    .type-pasivo { background: rgba(239,68,68,0.16); color: #fecdd3; border: 1px solid rgba(248,113,113,0.25); }

    .breakdown-list { display: grid; gap: 8px; margin: 10px 0 0; padding: 0; list-style: none; }
    .breakdown-item { background: #0f172a; border: 1px solid #1f2937; border-radius: 10px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }

    @media (max-width: 720px) {
      header { padding: 18px 16px 0; }
      .grid { padding: 8px 16px 24px; }
      .flex-row { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="title">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--accent);"></div>
      <h1>Panel de finanzas personales</h1>
      <span class="pill">HTML + localStorage</span>
    </div>
      <p class="muted" style="margin: 6px 0 14px; max-width: 820px;">
      Registra activos y pasivos en un solo panel. Los datos se guardan en <strong>localStorage</strong> del navegador y puedes exportarlos/importarlos en CSV, generar un PDF o borrarlos cuando quieras.
    </p>
    <div class="totals">
      <div class="card">
        <div class="muted" style="font-size: 13px;">Total activos</div>
        <div style="font-size: 26px; font-weight: 700;" id="total-activos">$0.00</div>
        <div class="badge" id="count-activos">0 registros</div>
      </div>
      <div class="card">
        <div class="muted" style="font-size: 13px;">Total pasivos</div>
        <div style="font-size: 26px; font-weight: 700;" id="total-pasivos">$0.00</div>
        <div class="badge" id="count-pasivos">0 registros</div>
      </div>
      <div class="card">
        <div class="muted" style="font-size: 13px;">Acciones rápidas</div>
        <div class="flex-row">
          <button class="secondary-btn" id="pdf-report" type="button">Generar PDF</button>
          <button class="secondary-btn" id="export-data" type="button">Exportar CSV</button>
          <button class="secondary-btn" id="import-data" type="button">Importar CSV</button>
          <input type="file" id="import-file" accept=".csv" style="display: none;">
          <button class="secondary-btn" id="clear-data" type="button" style="color: #fca5a5; border-color: #b91c1c;">Borrar datos</button>
        </div>
      </div>
    </div>
  </header>

  <main class="grid">
    <section class="card">
        <h2>Registrar transacción</h2>
        <form id="record-form">
          <label for="type">Tipo</label>
          <select id="type" name="type" required>
            <option value="Activo">Activo</option>
            <option value="Pasivo">Pasivo</option>
          </select>

          <label for="name">Nombre</label>
          <input id="name" name="name" placeholder="Cuenta, préstamo, vehículo" required>

          <label for="category">Categoría / Clase</label>
          <select id="category" name="category" required></select>
          <div id="custom-category-wrapper" style="margin-top: 8px; display: none;">
            <input id="custom-category" name="custom-category" placeholder="Escribe la categoría" />
          </div>

        <label for="amount">Monto</label>
        <input id="amount" name="amount" type="number" step="0.01" min="0" placeholder="5000" required>

        <label for="currency">Divisa</label>
        <input id="currency" name="currency" placeholder="USD, EUR, MXN" value="USD">

        <label for="date">Fecha</label>
        <input id="date" name="date" type="date" required>

        <label for="notes">Notas</label>
        <textarea id="notes" name="notes" rows="2" placeholder="Detalles, plazo, broker, etc."></textarea>

        <button type="submit" style="margin-top: 10px;">Agregar registro</button>
      </form>
    </section>

    <section class="card">
      <h2>Dashboard</h2>
      <canvas id="totals-chart" height="220"></canvas>
      <p class="muted" style="margin: 8px 0 0; font-size: 13px;">Distribución total por tipo (activos vs pasivos).</p>
    </section>

    <section class="card">
      <h2>Detalle de activos</h2>
      <ul class="breakdown-list" id="breakdown-activos"></ul>
    </section>
    <section class="card">
      <h2>Detalle de pasivos</h2>
      <ul class="breakdown-list" id="breakdown-pasivos"></ul>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
        <h2 style="margin: 0;">Listado de registros</h2>
        <div class="muted" style="font-size: 13px;">Los montos se muestran en la divisa que ingreses; no se aplican cambios de moneda.</div>
      </div>
      <div style="overflow-x: auto; margin-top: 10px;">
        <table class="table" id="records-table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Nombre</th>
              <th>Categoría / Clase</th>
              <th>Valor</th>
              <th>Divisa</th>
              <th>Fecha</th>
              <th>Notas</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const recordForm = document.getElementById('record-form');
    const typeSelect = document.getElementById('type');
    const tableBody = document.querySelector('#records-table tbody');
    const totalActivosEl = document.getElementById('total-activos');
    const totalPasivosEl = document.getElementById('total-pasivos');
    const countActivosEl = document.getElementById('count-activos');
    const countPasivosEl = document.getElementById('count-pasivos');
    const exportBtn = document.getElementById('export-data');
    const importBtn = document.getElementById('import-data');
    const importFileInput = document.getElementById('import-file');
    const clearBtn = document.getElementById('clear-data');
    const pdfBtn = document.getElementById('pdf-report');
    const breakdownActivos = document.getElementById('breakdown-activos');
    const breakdownPasivos = document.getElementById('breakdown-pasivos');
    const categorySelect = document.getElementById('category');
    const customCategoryInput = document.getElementById('custom-category');
    const customCategoryWrapper = document.getElementById('custom-category-wrapper');
    const dateInput = document.getElementById('date');
    const chartCanvas = document.getElementById('totals-chart');
    let totalsChart;

    const CATEGORY_OPTIONS = {
      Activo: [
        'Efectivo',
        'Cuenta bancaria',
        'Propiedad',
        'Vehículo',
        'Ahorro / Fondo',
        'Otros activos',
        'Otro (escribe)'
      ],
      Pasivo: [
        'Tarjeta de crédito',
        'Préstamo personal',
        'Hipoteca',
        'Servicios / Facturas',
        'Impuestos',
        'Otros pasivos',
        'Otro (escribe)'
      ]
    };

    const currencyFormat = (value) => new Intl.NumberFormat('es-ES', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    }).format(value || 0);

    const loadRecords = () => JSON.parse(localStorage.getItem('records') || '[]');
    const saveRecords = (records) => localStorage.setItem('records', JSON.stringify(records));

    const toCSV = (records) => {
      const headers = ['type', 'name', 'category', 'amount', 'currency', 'date', 'notes'];
      const escape = (value) => `"${String(value ?? '').replace(/"/g, '""')}"`;
      const lines = records.map((item) => headers.map((h) => escape(item[h])).join(','));
      return [headers.join(','), ...lines].join('\n');
    };

    const splitCSVLine = (line) => {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result.map((v) => v.trim());
    };

    const parseCSV = (text) => {
      const lines = text.split(/\r?\n/).filter((l) => l.trim().length);
      if (!lines.length) return [];
      const headers = splitCSVLine(lines[0]).map((h) => h.toLowerCase());
      const indices = {
        type: headers.indexOf('type'),
        name: headers.indexOf('name'),
        category: headers.indexOf('category'),
        amount: headers.indexOf('amount'),
        currency: headers.indexOf('currency'),
        date: headers.indexOf('date'),
        notes: headers.indexOf('notes'),
      };

      return lines.slice(1).map((line) => {
        const cols = splitCSVLine(line);
        const record = {
          type: cols[indices.type]?.trim(),
          name: cols[indices.name]?.trim(),
          category: cols[indices.category]?.trim(),
          amount: Number(cols[indices.amount] || 0),
          currency: cols[indices.currency]?.trim() || 'USD',
          date: cols[indices.date]?.trim() || '',
          notes: cols[indices.notes]?.trim() || '',
        };
        return record;
      }).filter((r) => r.type && ['Activo', 'Pasivo'].includes(r.type) && r.name && r.category);
    };

    const groupByCategory = (records, type) => {
      const filtered = records.filter((r) => r.type === type);
      return filtered.reduce((acc, item) => {
        const key = item.category || 'Sin categoría';
        acc[key] = (acc[key] || 0) + Number(item.amount || 0);
        return acc;
      }, {});
    };

    const renderBreakdown = (container, grouped) => {
      container.innerHTML = '';
      const entries = Object.entries(grouped).sort((a, b) => b[1] - a[1]);
      if (!entries.length) {
        container.innerHTML = '<li class="muted">Sin registros</li>';
        return;
      }
      entries.forEach(([category, total]) => {
        const li = document.createElement('li');
        li.className = 'breakdown-item';
        li.innerHTML = `<span>${category}</span><strong>$${currencyFormat(total)}</strong>`;
        container.appendChild(li);
      });
    };

    const renderChart = (totals) => {
      const data = [totals.activos, totals.pasivos];
      const labels = ['Activos', 'Pasivos'];
      if (totalsChart) {
        totalsChart.data.datasets[0].data = data;
        totalsChart.update();
        return;
      }
      totalsChart = new Chart(chartCanvas, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: ['#10b981', '#ef4444'],
            borderColor: '#0f172a',
          }],
        },
        options: {
          plugins: {
            legend: { labels: { color: '#e5e7eb' } },
          },
        },
      });
    };

    const render = () => {
      const records = loadRecords();
      tableBody.innerHTML = '';

      records.forEach((row, index) => {
        const tr = document.createElement('tr');
        const typeClass = row.type === 'Activo' ? 'type-activo' : 'type-pasivo';
        tr.innerHTML = `
          <td><span class="type-pill ${typeClass}">${row.type}</span></td>
          <td>${row.name}</td>
          <td>${row.category}</td>
          <td>$${currencyFormat(row.amount)}</td>
          <td>${row.currency || 'USD'}</td>
          <td>${row.date || ''}</td>
          <td>${row.notes || ''}</td>
          <td><button class="secondary-btn" data-index="${index}" type="button" style="color: #fca5a5; border-color: #b91c1c;">Eliminar</button></td>
        `;
        tableBody.appendChild(tr);
      });

      const totals = records.reduce((acc, item) => {
        const amt = Number(item.amount || 0);
        if (item.type === 'Activo') acc.activos += amt;
        if (item.type === 'Pasivo') acc.pasivos += amt;
        return acc;
      }, { activos: 0, pasivos: 0 });

      totalActivosEl.textContent = `$${currencyFormat(totals.activos)}`;
      totalPasivosEl.textContent = `$${currencyFormat(totals.pasivos)}`;

      const counts = records.reduce((acc, item) => {
        acc[item.type] = (acc[item.type] || 0) + 1;
        return acc;
      }, {});

      countActivosEl.textContent = `${counts['Activo'] || 0} registros`;
      countPasivosEl.textContent = `${counts['Pasivo'] || 0} registros`;

      renderBreakdown(breakdownActivos, groupByCategory(records, 'Activo'));
      renderBreakdown(breakdownPasivos, groupByCategory(records, 'Pasivo'));

      renderChart(totals);
    };

    const populateCategories = (type) => {
      const options = CATEGORY_OPTIONS[type] || [];
      categorySelect.innerHTML = '';
      options.forEach((cat) => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
      toggleCustomCategory();
    };

    const toggleCustomCategory = () => {
      const needsCustom = categorySelect.value && categorySelect.value.includes('Otro');
      customCategoryWrapper.style.display = needsCustom ? 'block' : 'none';
      customCategoryInput.required = !!needsCustom;
      if (!needsCustom) customCategoryInput.value = '';
    };

    recordForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(recordForm);
      const newRecord = {
        type: formData.get('type'),
        name: formData.get('name').trim(),
        category: (formData.get('category').includes('Otro')
          ? formData.get('custom-category').trim()
          : formData.get('category')).trim(),
        amount: Number(formData.get('amount')),
        currency: formData.get('currency').trim() || 'USD',
        date: formData.get('date'),
        notes: formData.get('notes').trim(),
      };

      if (!newRecord.name || !newRecord.category || Number.isNaN(newRecord.amount)) return;

      const records = loadRecords();
      records.unshift(newRecord);
      saveRecords(records);
      recordForm.reset();
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      render();
    });

    tableBody.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-index]');
      if (!btn) return;
      const records = loadRecords();
      const index = Number(btn.dataset.index);
      records.splice(index, 1);
      saveRecords(records);
      render();
    });

    exportBtn.addEventListener('click', () => {
      const data = loadRecords();
      const csv = toCSV(data);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'finanzas.csv';
      link.click();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => importFileInput.click());

    importFileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        const text = evt.target?.result;
        if (typeof text !== 'string') return;
        const imported = parseCSV(text);
        if (!imported.length) {
          alert('No se encontraron filas válidas en el CSV.');
          return;
        }
        const existing = loadRecords();
        saveRecords([...imported, ...existing]);
        render();
        importFileInput.value = '';
      };
      reader.readAsText(file);
    });

    clearBtn.addEventListener('click', () => {
      const confirmed = confirm('¿Seguro que deseas borrar todos los registros locales?');
      if (!confirmed) return;
      saveRecords([]);
      render();
    });

    pdfBtn.addEventListener('click', () => {
      const records = loadRecords();
      const totals = records.reduce((acc, item) => {
        const amt = Number(item.amount || 0);
        if (item.type === 'Activo') acc.activos += amt;
        if (item.type === 'Pasivo') acc.pasivos += amt;
        return acc;
      }, { activos: 0, pasivos: 0 });

      const reportWindow = window.open('', '_blank');
      const now = new Date();
      const dateStr = now.toLocaleDateString('es-ES');
      const timeStr = now.toLocaleTimeString('es-ES');
      const rows = records.map((r, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td>${r.type}</td>
          <td>${r.name}</td>
          <td>${r.category}</td>
          <td>${r.currency || 'USD'} ${currencyFormat(r.amount)}</td>
          <td>${r.date || ''}</td>
          <td>${r.notes || ''}</td>
        </tr>`).join('');

      reportWindow.document.write(`
        <html><head><title>Reporte financiero</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1, h2 { margin-bottom: 6px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; font-size: 12px; }
          th { background: #f1f5f9; }
          .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
          .card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
        </style></head><body>
        <h1>Reporte financiero</h1>
        <div>Generado el ${dateStr} a las ${timeStr}</div>
        <div class="summary">
          <div class="card"><strong>Total activos:</strong> $${currencyFormat(totals.activos)}</div>
          <div class="card"><strong>Total pasivos:</strong> $${currencyFormat(totals.pasivos)}</div>
        </div>
        <h2>Registros</h2>
        <table>
          <thead><tr><th>#</th><th>Tipo</th><th>Nombre</th><th>Categoría</th><th>Valor</th><th>Fecha</th><th>Notas</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="7">Sin registros</td></tr>'}</tbody>
        </table>
        </body></html>`);
      reportWindow.document.close();
      reportWindow.focus();
      reportWindow.print();
    });

    const init = () => {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      populateCategories('Activo');
      render();
    };

    typeSelect.addEventListener('change', (e) => {
      populateCategories(e.target.value);
    });

    categorySelect.addEventListener('change', toggleCustomCategory);

    init();
  </script>
</body>
</html>
